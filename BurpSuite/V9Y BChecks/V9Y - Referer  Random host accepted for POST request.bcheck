metadata:
    language: v2-beta
    name: "V9Y - Referer | Random host accepted for POST request"
    description: "Test for Referer header on 200 response code with POST request"
    author: "Vinaya Kumar"

run for each:
    potential_path = `v9y1dmn{random_str(8)}.com.sg`, `v9y2subdmn{random_str(5)}.{regex_replace({base.request.url.host}, "www\.", "")}`

given request then
    send request:
        headers:
            "Referer": {potential_path}
    
    if "200" in {latest.response.status_code} and "" in {base.response} then
        if {to_lower(potential_path)} in {to_lower(latest.response)} then
                report issue:
                    severity: medium
                    confidence: certain
                    detail: `User provided referer header reflected in the server response. The server may accept various domains in the REFERER header for state-changing (POST) operations (CASE 4).
                    LATEST STATUS CODE = {latest.response.status_code}
                    BASE STATUS CODE = {base.response.status_code}
                    HTTP_METHOD = {base.request.method}
                    REFERER used: {potential_path}`
           else if not("GET" in {latest.request.method}) then
		        report issue:
		            severity: low
		            confidence: certain
		            detail: `The server may accept various domains in the REFERER header for state-changing (POST) operations (CASE 5).
		            LATEST STATUS CODE = {latest.response.status_code}
		            BASE STATUS CODE = {base.response.status_code}
		            HTTP_METHOD = {base.request.method}
		            REFERER used: {potential_path}`
            end if
     end if
