metadata:
    language: v2-beta
    name: "V9Y - Referer | HTTP 30X Redirection"
    description: "Test for Referer header open redirections"
    author: "Vinaya Kumar"

run for each:
    potential_path = `v9y1dmn{random_str(8)}.com.sg`, `v9y2subdmn{random_str(5)}.{regex_replace({base.request.url.host}, "www\.", "")}`

given request then
    send request:
        headers:
            "Referer": {potential_path}

    if "30" in {latest.response.status_code} and "" in {base.response} then
        if {to_lower(potential_path)} in {to_lower(latest.response)} then
            if {latest.response.status_code} differs from {base.response.status_code} then
                report issue:
                    severity: medium
                    confidence: certain
                    detail: `The server response contains tampered REFERER header with HTTP 30X redirection. Also the base response status is different from new\latest status. This will be a potential issue.
                    LATEST STATUS CODE = {latest.response.status_code}
                    BASE STATUS CODE = {base.response.status_code} 
                HTTP_METHOD = {base.request.method}
                RESPONSE contains:\t{potential_path}
                REFERER used:\t\t\t{potential_path}`
#           else then
#               report issue:
#                   severity: low
#                   confidence: firm
#                   detail: `The server response contains tampered REFERER header with HTTP 30X redirection. But the base response status is same as new\latest status. This might be a potential issue.
#                   LATEST STATUS CODE = {latest.response.status_code}
#                   BASE STATUS CODE = {base.response.status_code} 
#                   RESPONSE contains {potential_path}
#                   HTTP_METHOD = {base.request.method}
#                   REFERER used: {potential_path}`

            end if
#        else then
#            report issue:
#                severity: info
#                confidence: tentative
#                detail: `The server response contains 30X status code but the tampered REFERER header is not found in the response. Low possibility of redirection to attacker controlled domain.
#                LATEST STATUS CODE = {latest.response.status_code}
#                BASE STATUS CODE = {base.response.status_code} 
#                RESPONSE doesn't contains {potential_path}
#                HTTP_METHOD = {base.request.method}
#                REFERER used: {potential_path}`
        end if
    end if